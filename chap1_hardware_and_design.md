# 软路由的硬件平台与内网设计

所谓`软路由`，就是用一台电脑配合相应的软件系统来运行路由器所提供的所有功能。相比与硬路由，软路由通常拥有更高的算力，更大的内存，这意味着软路由能提供比常规硬路由更多、更复杂的服务，例如本篇文章后面会将到的**负载均衡**、 **链路聚合**, **P2P下载服务**等等。。。  

目前有很多软路由系统，他们都是基于Linux内核搭建。如 毛子的 **OpenWrt**， 国内的有 **ikuai(爱快)**、 **Hi-Spider(海蜘蛛)** 等等， **下文将根据OpenWrt演示操作**，主要是OpenWrt生态最大，支持的硬件、平台最多。

硬件方面，软路由系统对性能要求并不高，市面上也有很多集成度很高的准系统，对体积较为在意的话可以选择如下图所示的这类准系统:

![20230320010412](https://s2.loli.net/2023/03/20/7OZjuAr6iYlxVJU.png)

1. **网口数量及网口带宽**。网口的速率决定了内网数据传输的上限，对于寝室环境来说一般千兆的速率就够用了，内网传输文件也有100Mb/s出头的速度。

2. **网卡是否支持虚拟化**。只有支持虚拟化的网卡才能将单个网口当多个使用，这在后续实现多线多播的时候能用上。

3. **是否有额外的sata接口**。如果要让自己的内网有个文件共享区，或者挂BT客户端，则需要在软路由中接入额外的硬盘。

4. **有无USB接口**。推荐把软路由系统装到U盘里，OpenWrt系统体积很小，使用U盘做系统盘是成本最低的方式。

如果你打算使用标准硬件，则需要注意**软路由硬件着重点在`功耗`、`网卡性能`、`体积`、`是否静音`上**。
所以**cpu推荐赛扬/奔腾系列、老i3/i5或者老至强那些支持DDR3内存的**。别问，问就是便宜的同时主板好挑且兼容性好。

**主板方面**，除了最基本的支持相应的cpu和内存外，**还需要注意PCIE X1, X4插槽数量**；另外不推荐为了体积小去选择itx主板，pcie插槽太少，matx就刚刚好。就是注意有些老主板上面除了一根PCIEx16外，其他的可能是PCI插槽，用PCI插槽可能导致网卡不兼容，**最后注意关注主板是否支持UEFI，这决定了后面安装OpenWRT是以什么方式启动的**。

**网卡方面**，重点来了啊！**推荐选择服务器网卡**，网口量大管饱，还大部分支持虚拟化。就是接口是pcie的服务器网卡很少。这里推荐我正在使用的型号 `HP 331flr` 4口千兆网卡，博通5719芯片； 注意它需要转接卡(虽然能插进pcie，但是惠普大聪明将线序反了一下)，海鲜市场一大把还便宜，网卡+转接卡在100元左右。

![20230320010550](https://s2.loli.net/2023/03/20/qMcl4YfuhbndZoW.png)

**内存/存储方面**, 内存ddr3还是ddr4请根据cpu来选择，重点是大小。如果hxd们关注过路由器配置，就会发现ram超过512M都是很高级的路由器了。OpenWrt对内存的占用量极少，我日常使用RAM占用在300M左右。如果你以后没有用docker跑网络服务的需求，则1G RAM 就足够了，2G RAM对于软路由来说绰绰有余。如果你以后还想进一步折腾全虚拟化服务器的话，内存推荐在8G或以上，不能低于4G。至于需不需要 ECC内存来增加软路由稳定性，我的意见是没必要，普通内存的稳定性就已经足够了，ECC内存特别挑CPU，小白特别容易买错。比如我用的 E3-1245v2 工作站cpu，支持不带寄存器的ECC内存，但是容易买成 带寄存器的ECC内存(REG ECC)，何必徒增这个麻烦呢？还更贵。

系统我强烈推荐安装到U盘上，软路由启动的次数相对较少，启动时大部分时间在读取，需要写入的任务也大多都是记录日志，U盘的IO性能完全足够；8G的U盘就够OpenWrt系统本体以及后续安装的其他软件了，为了后续扩展软路由的新功能，可以适当提高U盘容量，但没必要选择32G以上的U盘。

如上文所提到的，如果你想在软路由上挂BT下载或文件共享，则需要一个硬盘，容量根据自己需求选择，也没必要追求什么CMR或PMR硬盘，便宜又大碗的叠瓦盘性能就足够。当然前提是不整大容量的NAS(网络附属存储)和磁盘阵列。我的软路由上接的是一块给同学换PS4硬盘时白嫖的希捷1TB 2.5寸笔记本硬盘。

**电源方面**。跟自己组PC的方法一致，一般180W左右的电源就行，一定要选择可靠的品牌，如航嘉，金河田，ACBEL康舒等。我自己用的是ACBEL的180w半截ATX电源。   

**机箱方面**。讲究的就是一个体积小的同时PCIE插槽与主板匹配，比如说`乔斯伯C2` 这款机箱就很适合（我正在用的就是这款），虽然是个大闷罐，但是整机就没有什么功耗大的硬件。

**CPU散热方面**。不少准系统用的是被动散热，我推荐选择的cpu散热压力并不大，几乎市面上质量稍微好点的散热都能压的住。散热器主要一个就是静音，因此选择风扇直径大点， 转速低的下压式就行（如果你也跟我一样使用乔斯伯C2这款机箱，就只能用下压式散热器）。

