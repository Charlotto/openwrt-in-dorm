# 软路由的硬件平台与内网设计

所谓`软路由`，就是用一台电脑配合相应的软件系统来运行路由器所提供的所有功能。相比与硬路由，软路由通常拥有更高的算力，更大的内存，这意味着软路由能提供比常规硬路由更多、更复杂的服务，例如本篇文章后面会将到的**负载均衡**、 **链路聚合**, **P2P下载服务**等等。。。  

就一般来说，有三大硬件选择思路，每种都有优缺点，请根据自己的实际情况选择。

### 1. 准系统

最开始，有很多玩家发现用淘汰的工控机做软路由非常合适，网口多还便宜；后来随着需求量的增大，不少商家开始设计软路由半成品并出售，这种半成品软路由硬件就被称为准系统,它们通常使用 `intel 赛扬` 这类低功耗cpu。


![20230320010412](https://s2.loli.net/2023/03/20/7OZjuAr6iYlxVJU.png)


**优点：**

1. 静音，大多都用被动散热。
2. 体积小，能做到 178 * 122 * 55 (MM) 甚至更小，并通常与家庭硬路由一样用外置的12v直流供电。

**缺点:**

1. 网口数量无法扩展。
2. 性价比相对自己用PC硬件低

**有些准系统自带wifi功能，由于我没有实践验证这类无线网卡的性能，这里不做考虑，如有需要建议单独买硬路由接在软路由LAN口上使用**

在挑选准系统时除了看自己的预算，还需根据自身情况考虑如下需求：

**1. 网口数量及网口带宽：**
网口的速率决定了内网数据传输的上限，对于寝室环境来说一般 `1000mbps` 就够用了，内网传输文件也有100MB/s出头的速度。

<!-- TODO：添加引用到在虚拟网口上挂在认证客户端，解释为什么有时候需要多个WAN口 -->
网口数量限定了有多少设备可以直连软路由，如上图的4网口准系统，若两个用当做WAN口用于连接学校提供的网口，提供wifi的硬路由占用一个网口，还剩一个网口可以用于电脑直连软路由。

**2. 网卡是否支持虚拟化:**
只有支持虚拟化的网卡才能在同一个物理网口上挂载多个认证客户端，以达到充分利用带宽的目的。

**3. 是否有额外的sata接口:**
<!-- TODO: 解释 为什么是额外的stat接口 -->
如果要让自己的内网有个文件共享区，或者挂P2P下载客户端，则需要在软路由中接入额外的硬盘。

**4. 有无USB接口:**
推荐把软路由系统装到U盘里，OpenWrt系统体积很小，使用U盘做系统盘是成本最低的方式。

---
### 2. 常规PC硬件

如果你选择使用常见的PC硬件来搭建自己的软路由硬件系统，**其着重点在`功耗`、`网卡性能`、`体积`、`是否静音`、`性价比`上**, 所以**cpu推荐赛扬/奔腾系列、老i3/i5或者老至强那些支持DDR3内存的**。别问，问就是便宜的同时主板好挑且兼容性好。

**主板方面**，除了最基本的支持相应的cpu和内存外，**还需要注意PCIE X1, X4插槽数量**；另外不推荐为了体积小去选择itx主板，pcie插槽太少，matx就刚刚好。就是注意有些老主板上面除了一根PCIEx16外，其他的可能是PCI插槽，用PCI插槽可能导致网卡不兼容，**最后注意关注主板是否支持UEFI，这决定了后面安装OpenWRT是以什么方式启动的**。

**网卡方面**，重点来了啊！**推荐选择服务器网卡**，网口量大管饱，还大部分支持虚拟化。就是接口是pcie的服务器网卡很少。比如 `HP 331flr` 4口千兆网卡，博通5719芯片；注意它需要转接卡(虽然能插进pcie，但是惠普将线序反了一下)，海鲜市场一大把还便宜。

![20230320010550](https://s2.loli.net/2023/03/20/qMcl4YfuhbndZoW.png)

**内存方面**, 内存ddr3还是ddr4请根据cpu来选择，重点是大小。如果大家关注过路由器配置，就会发现 RAM 超过512M都是很高级的路由器了。OpenWrt对内存的占用量极少，实测日常使用 RAM 占用在300MB左右。如果你以后没有用docker跑网络服务的需求，则1G RAM 足矣，2G RAM对于软路由来说绰绰有余。如果你以后还想进一步折腾全虚拟化服务器的话，内存推荐在8G或以上，不能低于4G。至于需不需要 ECC内存来增加软路由稳定性，这里的意见是没必要，普通内存的稳定性就已经足够了，ECC内存特别挑CPU，小白特别容易买错。比 `E3-1245v2` 工作站cpu，支持不带寄存器的ECC内存，但是容易买成 带寄存器的ECC内存(REG ECC)，何必徒增这个麻烦呢？还更贵。

**存储方面**。 建议使用 U盘+硬盘的组合形式。由于Openwrt系统很小，4G的U盘就已经足够放下 Openwrt 本体和其他软件，还有空余空间用来安装额外插件和存放运行过程中生成的日志文件。
硬盘则负责提供本地文件共享和存放P2P下载的文件，当然如果你不需要这些功能可以不需要硬盘。

**电源方面**。与自己组PC的思路一致，一般180W左右的电源就行，由于软路由 7/24h 运行的特性一定要选择可靠的品牌，如航嘉，金河田，ACBEL康舒等。   

**机箱方面**。讲究的就是一个体积小的同时PCIE插槽与主板匹配，比如说`乔斯伯C2` 这款机箱就很适合，虽然是个大闷罐，但是软路由整机就没有什么功耗大的硬件，平时也不太可能满载。

**CPU散热方面**。不少准系统用的是被动散热，如果你选择几乎市面上质量稍微好点的散热都能压的住。散热器主要一个就是静音，因此选择风扇直径大点， 转速低的下压式就行（如果你也跟我一样使用乔斯伯C2这款机箱，就只能用下压式散热器）。

### 3. 硬路由改系统 

所谓硬路由改系统，就是给某个厂出的路由器刷第三方固件以达到可以使用软路由功能的方式。它在硬件选择上几乎没有什么难度，只要就着自己的预算去 [Openwrt支持硬件列表](https://openwrt.org/toh/start) 找路由器即可。刷第三方固件是这种方式最大的难点。

这里我以 `红米AX6000`举例，先去 [官方详情页](https://www.mi.com/shop/buy/detail?product_id=15820) 了解下它，发现它原生ROM就是 定制与OpenWrt


### 4. 内网设计